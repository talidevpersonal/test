import React from 'react';
import { render } from '@testing-library/react';
import { useTokenAutoRefresh } from './useTokenAutoRefresh';
import { Provider } from 'react-redux';
import configureStore from 'redux-mock-store';
import * as useAuthModule from './useAuth'; // assuming it's in same folder

jest.useFakeTimers();

const mockStore = configureStore([]);

describe('useTokenAutoRefresh', () => {
  let refreshTokenMock: jest.Mock;

  beforeEach(() => {
    refreshTokenMock = jest.fn();

    // Mock useAuth to return refreshToken
    jest.spyOn(useAuthModule, 'default').mockReturnValue({
      refreshToken: refreshTokenMock,
    });
  });

  afterEach(() => {
    jest.clearAllMocks();
  });

  const TestComponent = () => {
    useTokenAutoRefresh();
    return <div>Test</div>;
  };

  it('calls refreshToken before expiry time', () => {
    const store = mockStore({
      auth: {
        expires_in: Date.now() + 50000, // 50 seconds from now
      },
    });

    render(
      <Provider store={store}>
        <TestComponent />
      </Provider>
    );

    // Fast-forward timers to simulate passage of time
    jest.advanceTimersByTime(1000);

    expect(refreshTokenMock).toHaveBeenCalled();
  });

  it('does not call refreshToken if expires_in is not present', () => {
    const store = mockStore({
      auth: {
        expires_in: null,
      },
    });

    render(
      <Provider store={store}>
        <TestComponent />
      </Provider>
    );

    jest.advanceTimersByTime(1000);

    expect(refreshTokenMock).not.toHaveBeenCalled();
  });

  it('does not call refreshToken if expires_in is far in the future', () => {
    const store = mockStore({
      auth: {
        expires_in: Date.now() + 5 * 60 * 1000, // 5 minutes later
      },
    });

    render(
      <Provider store={store}>
        <TestComponent />
      </Provider>
    );

    jest.advanceTimersByTime(1000);

    expect(refreshTokenMock).not.toHaveBeenCalled();
  });
});
