<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Figma File Meta / Components / Styles</title>
</head>
<body>
  <h1>Figma Design Data Viewer</h1>

  <label>
    File key:
    <input id="fileKey" placeholder="Enter Figma File Key" style="width: 320px;" />
  </label>
  <br /><br />

  <button onclick="fetchFileMeta()">Get File Meta</button>
  <button onclick="fetchComponents()">Get Components</button>
  <button onclick="fetchStyles()">Get Styles</button>

  <pre id="output" style="margin-top: 16px; background: #111; color: #0f0; padding: 12px; max-height: 70vh; overflow: auto;"></pre>

  <script>
    // ⚠️ For local testing ONLY. Don't ship this token to production.
    const FIGMA_TOKEN = "YOUR_FIGMA_PERSONAL_ACCESS_TOKEN";

    function getFileKey() {
      const fileKey = document.getElementById("fileKey").value.trim();
      if (!fileKey) {
        alert("Please enter a file key");
        throw new Error("Missing fileKey");
      }
      return fileKey;
    }

    function setOutput(text) {
      document.getElementById("output").textContent = text;
    }

    async function safeFetch(url) {
      const res = await fetch(url, {
        headers: {
          "X-Figma-Token": FIGMA_TOKEN
        }
      });

      const text = await res.text();

      if (!res.ok) {
        throw new Error(`API Error ${res.status}:\n${text}`);
      }

      return JSON.parse(text);
    }

    // 1) Lightweight meta (you already used this)
    async function fetchFileMeta() {
      try {
        const fileKey = getFileKey();
        setOutput("Loading file metadata...");

        const url = `https://api.figma.com/v1/files/${encodeURIComponent(fileKey)}/meta`;
        const data = await safeFetch(url);

        const f = data.file || {};

        const meta = {
          name: f.name,
          folderName: f.folder_name,
          lastTouchedAt: f.last_touched_at,
          creator: f.creator?.handle || f.creator?.id || null,
          lastTouchedBy: f.last_touched_by?.handle || f.last_touched_by?.id || null,
          thumbnailUrl: f.thumbnail_url,
          editorType: f.editorType,
          version: f.version,
          role: f.role,
          linkAccess: f.link_access,
          url: f.url
        };

        setOutput(JSON.stringify(meta, null, 2));
      } catch (err) {
        setOutput("Error:\n" + err.message);
      }
    }

    // 2) Components metadata – good for mapping to React components
    async function fetchComponents() {
      try {
        const fileKey = getFileKey();
        setOutput("Loading components...");

        const url = `https://api.figma.com/v1/files/${encodeURIComponent(fileKey)}/components`;
        const data = await safeFetch(url);

        // data.meta.components is an array
        const components = (data.meta && data.meta.components) || [];

        // Simplify to essential fields
        const simplified = components.map(c => ({
          key: c.key,
          nodeId: c.node_id,
          name: c.name,
          description: c.description,
          createdAt: c.created_at,
          updatedAt: c.updated_at,
          visible: c.visible,
          containingFrame: c.containing_frame?.name || null,
          containingPage: c.containing_page?.name || null
        }));

        setOutput(JSON.stringify(simplified, null, 2));
      } catch (err) {
        setOutput("Error:\n" + err.message);
      }
    }

    // 3) Styles (text styles, color styles, effects, grids)
    async function fetchStyles() {
      try {
        const fileKey = getFileKey();
        setOutput("Loading styles...");

        const url = `https://api.figma.com/v1/files/${encodeURIComponent(fileKey)}/styles`;
        const data = await safeFetch(url);

        const styles = (data.meta && data.meta.styles) || [];

        // Group by style type (FILL, TEXT, EFFECT, GRID)
        const grouped = styles.reduce(
          (acc, s) => {
            const type = s.style_type || "UNKNOWN";
            if (!acc[type]) acc[type] = [];
            acc[type].push({
              key: s.key,
              name: s.name,
              description: s.description,
              remote: s.remote,
              createdAt: s.created_at,
              updatedAt: s.updated_at
            });
            return acc;
          },
          {}
        );

        setOutput(JSON.stringify(grouped, null, 2));
      } catch (err) {
        setOutput("Error:\n" + err.message);
      }
    }
  </script>
</body>
</html>
